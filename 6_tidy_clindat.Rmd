---
title: "crlm_tidy_clindat"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Generated on: `r Sys.time()`

Import required packages
```{r}
library(tidyverse)
library(readxl)
library(lubridate)
library(eeptools)
library(survival)
library(survminer)
```

```{r}
workDir <- "/home/bibu/Workspace/crlm_cohort/"
clinDataFn <- paste(workDir, "datasets/CRLM_clin_cohort.xlsx", sep="")
patDataFn <- paste(workDir, "datasets/CRLM_KS_cohort_pathology_200904.xlsx", sep="")
gpProbeFn <- paste(workDir, "output/gp_annotations_by_probe.csv", sep="")
tumorPercentProbeFn <- paste(workDir, "output/regression_by_probe.csv", sep="")
clinPatAnnotFn <- paste(workDir, "output/clin_data_annot.csv", sep="")
tumorPercentTumorFn <- paste(workDir, "output/regression_by_tumor.csv", sep="")
gpAnnotationsTumorFn <- paste(workDir, "output/gp_annotations_by_tumor.csv", sep="")

dateEndFu <- as.Date("2020-10-29") # Current date of end follow up for study
```

Import data
```{r}
# Modifications of CRLM_clin_cohort.xlsx:
#     -Deleted row 39: repeated case, see XZXZ	2/13/1973
#     -Row 6: date of progression in liver:  2012-11-19 > 11/19/2012

# Doubts: Ids 2 and 6, same date of date of progression and progression in liver
#         Id 11, no date for liver op   
 
# https://readxl.tidyverse.org/articles/cell-and-column-types.html
# Peek at column names in CRLM_clin_cohort.xlsx
(nms <- names(read_excel(clinDataFn, n_max = 0)))

# Columns to import from excel
# "PaRaMet.pseudonym", "dob", "sex", "date.of.liver.op", "date.of.death", 
# "Cancer.Related.Death..Y.N.U..unclear.", "date.of.progression.recidive", "date.of.progression.in.liver", "neoadjuvant..Y.N.", "sync.meta..s.m.", 
# "lost.for.follow.up"

# Read excel file
clinData <- read_excel(clinDataFn, n_max = 54, col_types = c(
  "numeric", "date", "text", "skip", "skip", "skip", "skip", "skip", "skip", "skip",
  "skip", "date", "skip", "skip", "skip", "skip", "skip", "date", "text", "skip",
  "date", "skip", "date", "skip", "skip", "text", "text", "skip", "skip", "skip",
  rep("skip", 16), "date"))

# Rename columns with easy and concise names: rename(flights, tail_num = tailnum)
(nms <- names(clinData))
clinData <- rename(clinData, id = "PaRaMet pseudonym", date_birth = dob, date_liver_op = "date of liver op", date_death = "date of death", 
                   cancer_death = "Cancer Related Death (Y/N/U, unclear)", date_progression = "date of progression/recidive", 
                   date_progression_liver = "date of progression in liver", neoadjuvant = "neoadjuvant (Y/N)", sync_meta = "sync/meta (s/m)",
                   date_lost_follow_up = "lost for follow up")
(nms <- names(clinData))

# Reorder columns
clinData <- clinData %>% relocate(sex, .after = id)
clinData <- clinData %>% relocate(date_progression, .after = date_liver_op)
clinData <- clinData %>% relocate(date_progression_liver, .after = date_progression)
clinData <- clinData %>% relocate(date_lost_follow_up, .after = date_death)
clinData <- clinData %>% relocate(sync_meta, .after = date_lost_follow_up)
clinData <- clinData %>% relocate(neoadjuvant, .after = sync_meta)
(nms <- names(clinData))

# Convert character values as factors or logical
clinData$sync_meta <- as.factor(clinData$sync_meta) # S(ynchronous) / M(etachronous)
clinData$sync_meta <- fct_relevel(clinData$sync_meta, "M", "S")

# TODO: Handle cancer_death Unknown
clinData$cancer_death <- as.factor(clinData$cancer_death) # Y(es) / N(o) / U(nknown)
clinData$cancer_death <- fct_relevel(clinData$cancer_death, "Y", "N", "U")

clinData$neoadjuvant <- as.factor(clinData$neoadjuvant) # Y(es) / N(o)
clinData$neoadjuvant <- fct_relevel(clinData$neoadjuvant, "Y", "N")

# Generate derived columns: time_follow_up, status_follow_up (1 - death observed, 0 - survival time censored)
# MOST IMPORTANT FOR SURV ANALYSYS, ALWAYS CHECK
fuDeath <- clinData %>% filter(!is.na(date_death)) %>% mutate(time_fu_os = as.double(difftime(date_death, date_liver_op, units = c("days"))), status_fu_os = 1)
fuAlive <- clinData %>% filter(is.na(date_death) & is.na(date_lost_follow_up)) %>% mutate(time_fu_os = as.double(difftime(dateEndFu, date_liver_op, units = c("days"))), status_fu_os = 0)
fuLost <- clinData %>% filter(!is.na(date_lost_follow_up)) %>% mutate(time_fu_os = as.double(difftime(date_lost_follow_up, date_liver_op, units = c("days"))), status_fu_os = 0)

clinSurvData <- rbind(fuDeath, fuAlive, fuLost)


#' Calculate age
#' 
#' By default, calculates the typical "age in years", with a
#' \code{floor} applied so that you are, e.g., 5 years old from
#' 5th birthday through the day before your 6th birthday. Set
#' \code{floor = FALSE} to return decimal ages, and change \code{units}
#' for units other than years.
#' @param dob date-of-birth, the day to start calculating age.
#' @param age.day the date on which age is to be calculated.
#' @param units unit to measure age in. Defaults to \code{"years"}. Passed to \link{\code{duration}}.
#' @param floor boolean for whether or not to floor the result. Defaults to \code{TRUE}.
#' @return Age in \code{units}. Will be an integer if \code{floor = TRUE}.
#' @examples
#' my.dob <- as.Date('1983-10-20')
#' age(my.dob)
#' age(my.dob, units = "minutes")
#' age(my.dob, floor = FALSE)
age <- function(dob, age.day = today(), units = "years", floor = TRUE) {
    calc.age = interval(dob, age.day) / duration(num = 1, units = units)
    if (floor) return(as.integer(floor(calc.age)))
    return(calc.age)
}
clinSurvData <- clinSurvData %>% mutate(age = age(date_birth, date_liver_op))
clinSurvData <- clinSurvData %>% relocate(age, .after = id)

# Dichotomize age
hist(clinSurvData$age)
clinSurvData <- clinSurvData %>% mutate(age_group = ifelse(age >=60, "60+", "<60"))
clinSurvData <- clinSurvData %>% relocate(age_group, .after = age)
```

Merge clinical with pathology report data
```{r}
# Peek at column names in CRLM_KS_cohort_pathology_200904
(nms <- names(read_excel(patDataFn, n_max = 0, skip = 2)))

# Read pathology report data
patDataOrig <- read_excel(patDataFn, n_max = 58, skip = 2, col_types = c(
  "skip", "numeric", "skip", "numeric", "text", 
  rep(c("numeric", rep("skip", 6), "numeric", "numeric"),3),
  "skip",
  rep(c("numeric", rep("skip", 6), "numeric", "numeric"),13)))

# TODO: Fix incorrect diameters in rows nr 5, 10, 14, 17

# Complete missing tumor % orig with review
patDataTemp <- patDataOrig %>% mutate('tumor_a_percent_tumor (%)' = ifelse(is.na(`tumor_a_percent_tumor_orig (%)`), `tumor_a_percent_tumor_review (%)`, `tumor_a_percent_tumor_orig (%)`))
patDataTemp <- patDataTemp %>% relocate(`tumor_a_percent_tumor (%)`, .before = `tumor_a_percent_tumor_orig (%)`)
patDataTemp <- patDataTemp %>% mutate('tumor_b_percent_tumor (%)' = ifelse(is.na(`tumor_b_percent_tumor_orig (%)`), `tumor_b_percent_tumor_review (%)`, `tumor_b_percent_tumor_orig (%)`))
patDataTemp <- patDataTemp %>% relocate(`tumor_b_percent_tumor (%)`, .before = `tumor_b_percent_tumor_orig (%)`)
patDataTemp <- patDataTemp %>% mutate('tumor_c_percent_tumor (%)' = ifelse(is.na(`tumor_c_percent_tumor_orig (%)`), `tumor_c_percent_tumor_review (%)`, `tumor_c_percent_tumor_orig (%)`))
patDataTemp <- patDataTemp %>% relocate(`tumor_c_percent_tumor (%)`, .before = `tumor_c_percent_tumor_orig (%)`)
patDataTemp <- patDataTemp %>% mutate('tumor_d_percent_tumor (%)' = ifelse(is.na(`tumor_d_percent_tumor_orig (%)`), `tumor_d_percent_tumor_review (%)`, `tumor_d_percent_tumor_orig (%)`))
patDataTemp <- patDataTemp %>% relocate(`tumor_d_percent_tumor (%)`, .before = `tumor_d_percent_tumor_orig (%)`)
patDataTemp <- patDataTemp %>% mutate('tumor_e_percent_tumor (%)' = ifelse(is.na(`tumor_e_percent_tumor_orig (%)`), `tumor_e_percent_tumor_review (%)`, `tumor_e_percent_tumor_orig (%)`))
patDataTemp <- patDataTemp %>% relocate(`tumor_e_percent_tumor (%)`, .before = `tumor_e_percent_tumor_orig (%)`)
patDataTemp <- patDataTemp %>% mutate('tumor_f_percent_tumor (%)' = ifelse(is.na(`tumor_f_percent_tumor_orig (%)`), `tumor_f_percent_tumor_review (%)`, `tumor_f_percent_tumor_orig (%)`))
patDataTemp <- patDataTemp %>% relocate(`tumor_f_percent_tumor (%)`, .before = `tumor_f_percent_tumor_orig (%)`)
patDataTemp <- patDataTemp %>% mutate('tumor_g_percent_tumor (%)' = ifelse(is.na(`tumor_g_percent_tumor_orig (%)`), `tumor_g_percent_tumor_review (%)`, `tumor_g_percent_tumor_orig (%)`))
patDataTemp <- patDataTemp %>% relocate(`tumor_g_percent_tumor (%)`, .before = `tumor_g_percent_tumor_orig (%)`)
patDataTemp <- patDataTemp %>% mutate('tumor_h_percent_tumor (%)' = ifelse(is.na(`tumor_h_percent_tumor_orig (%)`), `tumor_h_percent_tumor_review (%)`, `tumor_h_percent_tumor_orig (%)`))
patDataTemp <- patDataTemp %>% relocate(`tumor_h_percent_tumor (%)`, .before = `tumor_h_percent_tumor_orig (%)`)
patDataTemp <- patDataTemp %>% mutate('tumor_i_percent_tumor (%)' = ifelse(is.na(`tumor_i_percent_tumor_orig (%)`), `tumor_i_percent_tumor_review (%)`, `tumor_i_percent_tumor_orig (%)`))
patDataTemp <- patDataTemp %>% relocate(`tumor_i_percent_tumor (%)`, .before = `tumor_i_percent_tumor_orig (%)`)
patDataTemp <- patDataTemp %>% mutate('tumor_j_percent_tumor (%)' = ifelse(is.na(`tumor_j_percent_tumor_orig (%)`), `tumor_j_percent_tumor_review (%)`, `tumor_j_percent_tumor_orig (%)`))
patDataTemp <- patDataTemp %>% relocate(`tumor_j_percent_tumor (%)`, .before = `tumor_j_percent_tumor_orig (%)`)
patDataTemp <- patDataTemp %>% mutate('tumor_k_percent_tumor (%)' = ifelse(is.na(`tumor_k_percent_tumor_orig (%)`), `tumor_k_percent_tumor_review (%)`, `tumor_k_percent_tumor_orig (%)`))
patDataTemp <- patDataTemp %>% relocate(`tumor_k_percent_tumor (%)`, .before = `tumor_k_percent_tumor_orig (%)`)
patDataTemp <- patDataTemp %>% mutate('tumor_l_percent_tumor (%)' = ifelse(is.na(`tumor_l_percent_tumor_orig (%)`), `tumor_l_percent_tumor_review (%)`, `tumor_l_percent_tumor_orig (%)`))
patDataTemp <- patDataTemp %>% relocate(`tumor_l_percent_tumor (%)`, .before = `tumor_l_percent_tumor_orig (%)`)
patDataTemp <- patDataTemp %>% mutate('tumor_m_percent_tumor (%)' = ifelse(is.na(`tumor_m_percent_tumor_orig (%)`), `tumor_m_percent_tumor_review (%)`, `tumor_m_percent_tumor_orig (%)`))
patDataTemp <- patDataTemp %>% relocate(`tumor_m_percent_tumor (%)`, .before = `tumor_m_percent_tumor_orig (%)`)
patDataTemp <- patDataTemp %>% mutate('tumor_n_percent_tumor (%)' = ifelse(is.na(`tumor_n_percent_tumor_orig (%)`), `tumor_n_percent_tumor_review (%)`, `tumor_n_percent_tumor_orig (%)`))
patDataTemp <- patDataTemp %>% relocate(`tumor_n_percent_tumor (%)`, .before = `tumor_n_percent_tumor_orig (%)`)
patDataTemp <- patDataTemp %>% mutate('tumor_o_percent_tumor (%)' = ifelse(is.na(`tumor_o_percent_tumor_orig (%)`), `tumor_o_percent_tumor_review (%)`, `tumor_o_percent_tumor_orig (%)`))
patDataTemp <- patDataTemp %>% relocate(`tumor_o_percent_tumor (%)`, .before = `tumor_o_percent_tumor_orig (%)`)
patDataTemp <- patDataTemp %>% mutate('tumor_p_percent_tumor (%)' = ifelse(is.na(`tumor_p_percent_tumor_orig (%)`), `tumor_p_percent_tumor_review (%)`, `tumor_p_percent_tumor_orig (%)`))
patDataTemp <- patDataTemp %>% relocate(`tumor_p_percent_tumor (%)`, .before = `tumor_p_percent_tumor_orig (%)`)

# Derive max tumour diameter per probe
patDataTemp <- patDataTemp %>% rowwise() %>% mutate(max_diameter = max(c_across(contains("largest_diameter (cm)")), na.rm = TRUE))

# Derive sum of tumor diameters per probe
patDataTemp <- patDataTemp %>% rowwise() %>% mutate(sum_diameter = sum(c_across(contains("largest_diameter (cm)")), na.rm = TRUE))

# Derive mean regression per probe
patDataTemp <- patDataTemp %>% rowwise() %>% mutate(mean_tumor_percent_report = mean(c_across(contains("percent_tumor (%)")), na.rm = TRUE))
patDataTemp <-patDataTemp %>% mutate(mean_tumor_percent_report = ifelse(is.nan(mean_tumor_percent_report), NA, mean_tumor_percent_report) )

patDataTemp$mean_tumor_percent_report <- as.numeric(patDataTemp$mean_tumor_percent_report)

# Derive sum regression score per probe (sum of % tumor x diameter)
# TODO: sum of NA (or a product of it) is 0. We need to garantee every diameter is matched with percent tumour. Add integrity check code
patDataTemp <- patDataTemp %>%  mutate(sum_tumour_score_report = sum(
  `tumor_a_percent_tumor (%)` * `tumor_a_largest_diameter (cm)`, `tumor_b_percent_tumor (%)` * `tumor_b_largest_diameter (cm)`,
  `tumor_c_percent_tumor (%)` * `tumor_c__largest_diameter (cm)`, `tumor_d_percent_tumor (%)` * `tumor_d__largest_diameter (cm)`,
  `tumor_e_percent_tumor (%)` * `tumor_e__largest_diameter (cm)`, `tumor_f_percent_tumor (%)` * `tumor_f__largest_diameter (cm)`,
  `tumor_g_percent_tumor (%)` * `tumor_g__largest_diameter (cm)`, `tumor_h_percent_tumor (%)` * `tumor_h__largest_diameter (cm)`,
  `tumor_i_percent_tumor (%)` * `tumor_i__largest_diameter (cm)`, `tumor_j_percent_tumor (%)` * `tumor_j__largest_diameter (cm)`,
  `tumor_k_percent_tumor (%)` * `tumor_k__largest_diameter (cm)`, `tumor_l_percent_tumor (%)` * `tumor_l__largest_diameter (cm)`,
  `tumor_m_percent_tumor (%)` * `tumor_m__largest_diameter (cm)`, `tumor_n_percent_tumor (%)` * `tumor_n__largest_diameter (cm)`,
  `tumor_o_percent_tumor (%)` * `tumor_o__largest_diameter (cm)`, `tumor_p_percent_tumor (%)` * `tumor_p__largest_diameter (cm)`
  , na.rm = TRUE))
# UGLY AND BUGGY HACK - We loose complete regressions, fix above
patDataTemp <-patDataTemp %>% mutate(sum_tumour_score_report = na_if(sum_tumour_score_report, 0.0))

# Useless snippet: patDataTemp <- patDataTemp %>% mutate(across(contains("percent_tumor_orig"), .names = "NEW_{col}")) %>% rename_with( ~ gsub("_orig (%)", "", .x, fixed = TRUE), .cols = contains("NEW_")) %>% rename_with( ~ gsub("NEW_", "", .x, fixed = TRUE), .cols = contains("NEW_"))

# Leave out per tumour nodule columns
patData <- patDataTemp %>% select(-contains("largest_diameter"), -contains("tumor_orig"), -contains("tumor_review"), -contains("percent_tumor (%)"))

# Rename columns
patData <- rename(patData, id = "projectnr", marginal = "min_dist_lever_rr (mm)")
                   
# Convert marginal <1 into 0.5 and make it numeric
patData$marginal <- gsub("<1", "0.5", patData$marginal, fixed = TRUE)
patData$marginal <- as.numeric(patData$marginal)

# Dichotomize num_tumors
table(patData$num_tumors)
hist(patData$num_tumors, breaks = 20)
patData <- patData %>% mutate(num_tumors_group = ifelse(num_tumors >=4, "4+", "<4"))
patData <- patData %>% relocate(num_tumors_group, .after = num_tumors)

# Dichotomize largest tumors diameter
table(patData$max_diameter)
hist(patData$max_diameter)
patData <- patData %>% mutate(max_diameter_group = ifelse(max_diameter >=5, "5+", "<5"))
patData <- patData %>% relocate(max_diameter_group, .after = max_diameter)

# Dichotomize sum tumor diameters
table(patData$sum_diameter)
hist(patData$sum_diameter)
patData <- patData %>% mutate(sum_diameter_group = ifelse(sum_diameter >=9, "9+", "<9")) # Significant already with 7
patData <- patData %>% relocate(sum_diameter_group, .after = sum_diameter)

# Dichotomize marginal with 0 and 1 mm as cut-offs
table(patData$marginal)
hist(patData$marginal, freq = TRUE, breaks = c(0, 1, 5, seq(10, max(patData$marginal, na.rm = TRUE), by = 10)))
patData <- patData %>% mutate(marginal_group0 = ifelse(marginal > 0, ">0", "0"))
patData <- patData %>% relocate(marginal_group0, .after = marginal)

patData <- patData %>% mutate(marginal_group1 = ifelse(marginal >= 1, "1+", "<1"))
patData <- patData %>% relocate(marginal_group1, .after = marginal_group0)

patData <- patData %>% mutate(marginal_group01 = ifelse(marginal == 0, "0", ifelse(marginal >= 1, "1+", "<1") ))
patData <- patData %>% relocate(marginal_group01, .after = marginal_group1)

# Dichotomize mean tumor percent
table(patData$mean_tumor_percent_report)
hist(patData$mean_tumor_percent_report, freq = TRUE, breaks = c(0, 5, seq(10, 100, by = 10)))
#patData <- patData %>% mutate(tum_percent_gr = ifelse(mean_tumor_percent >= 50, "50+", "<50"))
patData <- patData %>% mutate(tum_percent_report_group = ifelse(mean_tumor_percent_report == 0, "<0",
                                                                ifelse(mean_tumor_percent_report > 0 & mean_tumor_percent_report < 50, "1-50", "50+")))
patData <- patData %>% relocate(tum_percent_report_group, .after = mean_tumor_percent_report)

# Dichotomize sum regression score
table(patData$sum_tumour_score_report)
hist(patData$sum_tumour_score_report)
patData <- patData %>% mutate(sum_tumour_score_report_group = ifelse(sum_tumour_score_report >= 250, "250+", "<250"))
patData <- patData %>% relocate(sum_tumour_score_report_group, .after = sum_tumour_score_report)

# Merge clinical and pathology report data
clinPatData <- merge(clinSurvData, patData, by = "id", all.x = TRUE)
```

Read and process annotation derived GP data
```{r }
gpProbeOrig <- read.csv(gpProbeFn, row.names=NULL)
gpProbeOrig$annotation_types <- fct_relevel(gpProbeOrig$annotation_types, "P", "D","R2", "R")

# Rename columns
gpProbeOrig <- gpProbeOrig %>% rename(id = ids)

# Initialize % of replacement for every tumor, so those with 0 % are captured in next filter
for(an_id in unique(gpProbeOrig$id)) {
  gpProbeOrig <- gpProbeOrig %>% add_row(id = an_id, annotation_types = "R", length_um = 0, percent_gp = 0)
}

# Derive % replacement per probe
gpProbeReplacement <- gpProbeOrig %>% group_by(id) %>% filter(annotation_types == "R" | annotation_types == "R2") %>% summarise(replacement_percent = sum(percent_gp) )

# Dichotomize % replacement
table(gpProbeReplacement$replacement_percent)
hist(gpProbeReplacement$replacement_percent)
gpProbeReplacement <- gpProbeReplacement %>% mutate(replacement_group = ifelse(replacement_percent == 0, "0",
                                                                ifelse(replacement_percent > 0 & replacement_percent < 50, "1-50", "50+")))
gpProbeReplacement <- gpProbeReplacement %>% relocate(replacement_percent, .after = replacement_percent)
```

Read and process annotation derived regression data
```{r }
tumorPercentProbeOrig <- read.csv(tumorPercentProbeFn, row.names=NULL)

# Rename columns
tumorPercentProbe <- tumorPercentProbeOrig %>% rename(id = ids, tum_percent_annot = avg_percent)

# Dichotomize % tumor annot
table(tumorPercentProbe$tum_percent_annot)
hist(tumorPercentProbe$tum_percent_annot)
tumorPercentProbe <- tumorPercentProbe %>% mutate(tum_percent_annot_group = ifelse(tum_percent_annot == 0, "0",
                                                                ifelse(tum_percent_annot > 0 & tum_percent_annot < 50, "1-50", "50+")))
```

Merge annotation derived regression and GP data with clinPath data
```{r }
clinPatAnnotationData <- merge(clinPatData, gpProbeReplacement, by = "id", all.x = TRUE)
clinPatAnnotationData <- merge(clinPatAnnotationData, tumorPercentProbe, by = "id", all.x = TRUE)
```

Weighted annotation derived regression
```{r }
# Extract id and tumor diameters 
tumDiameters <- patDataTemp %>% select(projectnr, contains("_largest_diameter"))
tumDiameters <- rename(tumDiameters, id = "projectnr")

tumPercentByTumor <- read.csv(tumorPercentTumorFn)
tumPercentByTumorWide <- tumPercentByTumor %>% pivot_wider(names_from = tumors, values_from = avg_percent, names_prefix = "%_tum_ann_")
tumPercentByTumorWide <- tumPercentByTumorWide %>% rename(id = "ids")
tumPercentByTumorDiams <- merge(tumPercentByTumorWide, tumDiameters, by = "id")

# Set aside % tumor and largest diameter for easier visual assessment
tumPercentByTumorDiams <- tumPercentByTumorDiams %>% relocate(`tumor_a_largest_diameter (cm)`, .after = `%_tum_ann_a`)
tumPercentByTumorDiams <- tumPercentByTumorDiams %>% relocate(`tumor_b_largest_diameter (cm)`, .after = `%_tum_ann_b`)
tumPercentByTumorDiams <- tumPercentByTumorDiams %>% relocate(`tumor_c__largest_diameter (cm)`, .after = `%_tum_ann_c`)
tumPercentByTumorDiams <- tumPercentByTumorDiams %>% relocate(`tumor_d__largest_diameter (cm)`, .after = `%_tum_ann_d`)
tumPercentByTumorDiams <- tumPercentByTumorDiams %>% relocate(`tumor_e__largest_diameter (cm)`, .after = `%_tum_ann_e`)
tumPercentByTumorDiams <- tumPercentByTumorDiams %>% relocate(`tumor_f__largest_diameter (cm)`, .after = `%_tum_ann_f`)
tumPercentByTumorDiams <- tumPercentByTumorDiams %>% relocate(`tumor_g__largest_diameter (cm)`, .after = `%_tum_ann_g`)
tumPercentByTumorDiams <- tumPercentByTumorDiams %>% relocate(`tumor_h__largest_diameter (cm)`, .after = `%_tum_ann_h`)
tumPercentByTumorDiams <- tumPercentByTumorDiams %>% relocate(`tumor_i__largest_diameter (cm)`, .after = `%_tum_ann_i`)
tumPercentByTumorDiams <- tumPercentByTumorDiams %>% relocate(`tumor_j__largest_diameter (cm)`, .after = `%_tum_ann_j`)
tumPercentByTumorDiams <- tumPercentByTumorDiams %>% relocate(`tumor_k__largest_diameter (cm)`, .after = `%_tum_ann_k`)
tumPercentByTumorDiams <- tumPercentByTumorDiams %>% relocate(`tumor_l__largest_diameter (cm)`, .after = `%_tum_ann_l`)
tumPercentByTumorDiams <- tumPercentByTumorDiams %>% relocate(`tumor_m__largest_diameter (cm)`, .after = `%_tum_ann_m`)
tumPercentByTumorDiams <- tumPercentByTumorDiams %>% relocate(`tumor_n__largest_diameter (cm)`, .after = `%_tum_ann_n`)
tumPercentByTumorDiams <- tumPercentByTumorDiams %>% relocate(`tumor_o__largest_diameter (cm)`, .after = `%_tum_ann_o`)
tumPercentByTumorDiams <- tumPercentByTumorDiams %>% relocate(`tumor_p__largest_diameter (cm)`, .after = `%_tum_ann_p`)

# TODO: Implement a check so that for every tumor with diameter should be a % annotation tumor

# Derive sum regression score per probe (sum of % tumor x diameter)
# TODO: sum of NA (or a product of it) is 0. We need to garantee every diameter is matched with percent tumour. Add integrity check code
tumPercentByTumorDiams <- tumPercentByTumorDiams %>% rowwise() %>%  mutate(sum_tumour_score_annot = sum(
  `%_tum_ann_a` * `tumor_a_largest_diameter (cm)`, `%_tum_ann_b` * `tumor_b_largest_diameter (cm)`,
  `%_tum_ann_c` * `tumor_c__largest_diameter (cm)`, `%_tum_ann_d` * `tumor_d__largest_diameter (cm)`,
  `%_tum_ann_e` * `tumor_e__largest_diameter (cm)`, `%_tum_ann_f` * `tumor_f__largest_diameter (cm)`,
  `%_tum_ann_g` * `tumor_g__largest_diameter (cm)`, `%_tum_ann_h` * `tumor_h__largest_diameter (cm)`,
  `%_tum_ann_i` * `tumor_i__largest_diameter (cm)`, `%_tum_ann_j` * `tumor_j__largest_diameter (cm)`,
  `%_tum_ann_k` * `tumor_k__largest_diameter (cm)`, `%_tum_ann_l` * `tumor_l__largest_diameter (cm)`,
  `%_tum_ann_m` * `tumor_m__largest_diameter (cm)`, `%_tum_ann_n` * `tumor_n__largest_diameter (cm)`,
  `%_tum_ann_o` * `tumor_o__largest_diameter (cm)`, `%_tum_ann_p` * `tumor_p__largest_diameter (cm)`
  , na.rm = TRUE))
tumPercentByTumorDiams <- tumPercentByTumorDiams %>% relocate(sum_tumour_score_annot, .after = id)

# Leave out per tumour nodule columns
tumPercentByTumorDiamsTrim <- tumPercentByTumorDiams %>% select(-contains("largest_diameter"), -contains("%_tum_ann"))

# Dichotomize sum tumor score annot
hist(tumPercentByTumorDiamsTrim$sum_tumour_score_annot)
tumPercentByTumorDiamsTrim <- tumPercentByTumorDiamsTrim %>% mutate(sum_tumour_score_annot_group = ifelse(sum_tumour_score_annot >= 250, "250+", "<250"))
tumPercentByTumorDiamsTrim <- tumPercentByTumorDiamsTrim %>% relocate(sum_tumour_score_annot_group, .after = sum_tumour_score_annot)

clinPatAnnotationData <- merge(clinPatAnnotationData, tumPercentByTumorDiamsTrim)
```

Merge annotation derived regression data with clinPath data
```{r }
gpByTumor <- read.csv(gpAnnotationsTumorFn)
gpByTumor <- gpByTumor %>% select(-length_um)

# Initialize % of replacement for every tumor, so those with 0 % are captured in next filter
for(an_id in unique(gpByTumor$ids)) {
  for(a_tumor in unique(gpByTumor[ gpByTumor$ids == an_id, ]$tumors)) {
    gpByTumor <- gpByTumor %>% add_row(ids = an_id, tumors = a_tumor, annotation_types = "R", percent_gp = 0)
  }
}

# Derive % replacement per probe
replacementByTumor <- gpByTumor %>% group_by(ids, tumors) %>% filter(annotation_types == "R" | annotation_types == "R2") %>% summarise(replacement_percent = sum(percent_gp) )
replacementByTumorWide <- replacementByTumor %>% pivot_wider(names_from = tumors, values_from = replacement_percent, names_prefix = "replacement_tum_ann_")

replacementByTumorWide <- replacementByTumorWide %>% rename(id = "ids")
replacementByTumorDiams <- merge(replacementByTumorWide, tumDiameters, by = "id")

# Set aside % tumor and largest diameter for easier visual assessment
replacementByTumorDiams <- replacementByTumorDiams %>% relocate(`tumor_a_largest_diameter (cm)`, .after = `replacement_tum_ann_a`)
replacementByTumorDiams <- replacementByTumorDiams %>% relocate(`tumor_b_largest_diameter (cm)`, .after = `replacement_tum_ann_b`)
replacementByTumorDiams <- replacementByTumorDiams %>% relocate(`tumor_c__largest_diameter (cm)`, .after = `replacement_tum_ann_c`)
replacementByTumorDiams <- replacementByTumorDiams %>% relocate(`tumor_d__largest_diameter (cm)`, .after = `replacement_tum_ann_d`)
replacementByTumorDiams <- replacementByTumorDiams %>% relocate(`tumor_e__largest_diameter (cm)`, .after = `replacement_tum_ann_e`)
replacementByTumorDiams <- replacementByTumorDiams %>% relocate(`tumor_f__largest_diameter (cm)`, .after = `replacement_tum_ann_f`)
replacementByTumorDiams <- replacementByTumorDiams %>% relocate(`tumor_g__largest_diameter (cm)`, .after = `replacement_tum_ann_g`)
replacementByTumorDiams <- replacementByTumorDiams %>% relocate(`tumor_h__largest_diameter (cm)`, .after = `replacement_tum_ann_h`)
replacementByTumorDiams <- replacementByTumorDiams %>% relocate(`tumor_i__largest_diameter (cm)`, .after = `replacement_tum_ann_i`)
replacementByTumorDiams <- replacementByTumorDiams %>% relocate(`tumor_j__largest_diameter (cm)`, .after = `replacement_tum_ann_j`)
replacementByTumorDiams <- replacementByTumorDiams %>% relocate(`tumor_k__largest_diameter (cm)`, .after = `replacement_tum_ann_k`)
replacementByTumorDiams <- replacementByTumorDiams %>% relocate(`tumor_l__largest_diameter (cm)`, .after = `replacement_tum_ann_l`)
replacementByTumorDiams <- replacementByTumorDiams %>% relocate(`tumor_m__largest_diameter (cm)`, .after = `replacement_tum_ann_m`)
replacementByTumorDiams <- replacementByTumorDiams %>% relocate(`tumor_n__largest_diameter (cm)`, .after = `replacement_tum_ann_n`)
replacementByTumorDiams <- replacementByTumorDiams %>% relocate(`tumor_o__largest_diameter (cm)`, .after = `replacement_tum_ann_o`)
replacementByTumorDiams <- replacementByTumorDiams %>% relocate(`tumor_p__largest_diameter (cm)`, .after = `replacement_tum_ann_p`)

# TODO: Implement a check so that for every tumor with diameter should be a % annotation tumor

# Derive sum regression score per probe (sum of % tumor x diameter)
# TODO: sum of NA (or a product of it) is 0. We need to garantee every diameter is matched with percent tumour. Add integrity check code
replacementByTumorDiams <- replacementByTumorDiams %>% rowwise() %>%  mutate(sum_replacement_score_annot = sum(
  `replacement_tum_ann_a` * `tumor_a_largest_diameter (cm)`, `replacement_tum_ann_b` * `tumor_b_largest_diameter (cm)`,
  `replacement_tum_ann_c` * `tumor_c__largest_diameter (cm)`, `replacement_tum_ann_d` * `tumor_d__largest_diameter (cm)`,
  `replacement_tum_ann_e` * `tumor_e__largest_diameter (cm)`, `replacement_tum_ann_f` * `tumor_f__largest_diameter (cm)`,
  `replacement_tum_ann_g` * `tumor_g__largest_diameter (cm)`, `replacement_tum_ann_h` * `tumor_h__largest_diameter (cm)`,
  `replacement_tum_ann_i` * `tumor_i__largest_diameter (cm)`, `replacement_tum_ann_j` * `tumor_j__largest_diameter (cm)`,
  `replacement_tum_ann_k` * `tumor_k__largest_diameter (cm)`, `replacement_tum_ann_l` * `tumor_l__largest_diameter (cm)`,
  `replacement_tum_ann_m` * `tumor_m__largest_diameter (cm)`, `replacement_tum_ann_n` * `tumor_n__largest_diameter (cm)`,
  `replacement_tum_ann_o` * `tumor_o__largest_diameter (cm)`, `replacement_tum_ann_p` * `tumor_p__largest_diameter (cm)`
  , na.rm = TRUE))
replacementByTumorDiams <- replacementByTumorDiams %>% relocate(sum_replacement_score_annot, .after = id)

# Leave out per tumour nodule columns
replacementByTumorDiamsTrim <- replacementByTumorDiams %>% select(-contains("largest_diameter"), -contains("replacement_tum_ann"))

# Dichotomize sum replacement score annot
hist(replacementByTumorDiamsTrim$sum_replacement_score_annot)
replacementByTumorDiamsTrim <- replacementByTumorDiamsTrim %>% mutate(sum_replacement_score_annot_group = ifelse(sum_replacement_score_annot == 0, "0",
                                                                ifelse(sum_replacement_score_annot > 0 & sum_replacement_score_annot < 150, "1-150", "150+")))
replacementByTumorDiamsTrim <- replacementByTumorDiamsTrim %>% relocate(sum_replacement_score_annot_group, .after = sum_replacement_score_annot)

clinPatAnnotationData <- merge(clinPatAnnotationData, replacementByTumorDiamsTrim)
```

Final cleanup
```{r }
clinPatAnnotationData <- clinPatAnnotationData %>% rename(age_ = age_group)
clinPatAnnotationData <- clinPatAnnotationData %>% rename(num_tumors_ = num_tumors_group)
clinPatAnnotationData <- clinPatAnnotationData %>% rename(max_tum_diameter = max_diameter_group)
clinPatAnnotationData <- clinPatAnnotationData %>% rename(sum_tum_diameter = sum_diameter_group)
clinPatAnnotationData <- clinPatAnnotationData %>% rename(marginal0 = marginal_group0)
clinPatAnnotationData <- clinPatAnnotationData %>% rename(marginal1 = marginal_group1)
clinPatAnnotationData <- clinPatAnnotationData %>% rename(marginal01 = marginal_group01)
clinPatAnnotationData <- clinPatAnnotationData %>% rename(tum_percent_report = tum_percent_report_group)
clinPatAnnotationData <- clinPatAnnotationData %>% rename(tum_score_report = sum_tumour_score_report_group)
clinPatAnnotationData <- clinPatAnnotationData %>% rename(tum_percent_annot_ = tum_percent_annot_group)
clinPatAnnotationData <- clinPatAnnotationData %>% rename(tum_score_annot_ = sum_tumour_score_annot_group)
clinPatAnnotationData <- clinPatAnnotationData %>% rename(replacement = replacement_group)
clinPatAnnotationData <- clinPatAnnotationData %>% rename(replacement_score = sum_replacement_score_annot_group)

write.csv(clinPatAnnotationData, clinPatAnnotFn)
```